#include "lcd_gc9a01.h"
#include "../include/pins.h"
#include <SPI.h>

namespace sedu::lcd {

namespace {
constexpr uint8_t kCs = sedu::pins::kSpiCsLcd;
constexpr uint8_t kDc = sedu::pins::kLcdDc;
constexpr uint8_t kRst = sedu::pins::kLcdRst;
SPISettings kSettings(20000000, MSBFIRST, SPI_MODE0);
constexpr uint16_t kW = 240;
constexpr uint16_t kH = 240;

void sendCmd(uint8_t cmd) {
  SPI.beginTransaction(kSettings);
  digitalWrite(kCs, LOW);
  digitalWrite(kDc, LOW);
  SPI.transfer(cmd);
  digitalWrite(kCs, HIGH);
  SPI.endTransaction();
}

void sendData(uint8_t data) {
  SPI.beginTransaction(kSettings);
  digitalWrite(kCs, LOW);
  digitalWrite(kDc, HIGH);
  SPI.transfer(data);
  digitalWrite(kCs, HIGH);
  SPI.endTransaction();
}

void cmdData(uint8_t cmd, const uint8_t* data, size_t n) {
  sendCmd(cmd);
  while (n--) sendData(*data++);
}

void setAddrWindow(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1) {
  uint8_t data[4];
  data[0] = x0 >> 8; data[1] = x0 & 0xFF; data[2] = x1 >> 8; data[3] = x1 & 0xFF;
  cmdData(0x2A, data, 4);  // CASET
  data[0] = y0 >> 8; data[1] = y0 & 0xFF; data[2] = y1 >> 8; data[3] = y1 & 0xFF;
  cmdData(0x2B, data, 4);  // RASET
  sendCmd(0x2C);           // RAMWR
}

inline uint16_t color565(uint8_t r, uint8_t g, uint8_t b) {
  return ((r & 0xF8) << 8) | ((g & 0xFC) << 3) | (b >> 3);
}

void pushColor(uint16_t c, uint32_t count) {
  SPI.beginTransaction(kSettings);
  digitalWrite(kCs, LOW);
  digitalWrite(kDc, HIGH);
  uint8_t hi = c >> 8, lo = c & 0xFF;
  while (count--) {
    SPI.transfer(hi);
    SPI.transfer(lo);
  }
  digitalWrite(kCs, HIGH);
  SPI.endTransaction();
}

void fillRect(uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t c) {
  if (x >= kW || y >= kH) return;
  if (x + w > kW) w = kW - x;
  if (y + h > kH) h = kH - y;
  setAddrWindow(x, y, x + w - 1, y + h - 1);
  pushColor(c, static_cast<uint32_t>(w) * h);
}

// 6x8 font (subset): ASCII 32..90 (space..'Z'), digits, '.', '%', ':'
static const uint8_t kFont6x8[][6] = {
  {0,0,0,0,0,0}, // 32 ' '
  {0x00,0x00,0x5F,0x00,0x00,0x00}, // 33 '!'
  {0x00,0x07,0x00,0x07,0x00,0x00}, // '"'
  {0x14,0x7F,0x14,0x7F,0x14,0x00}, // '#'
  {0x24,0x2A,0x7F,0x2A,0x12,0x00}, // '$'
  {0x23,0x13,0x08,0x64,0x62,0x00}, // '%'
  {0x36,0x49,0x55,0x22,0x50,0x00}, // '&'
  {0x00,0x05,0x03,0x00,0x00,0x00}, // '\''
  {0x00,0x1C,0x22,0x41,0x00,0x00}, // '('
  {0x00,0x41,0x22,0x1C,0x00,0x00}, // ')'
  {0x14,0x08,0x3E,0x08,0x14,0x00}, // '*'
  {0x08,0x08,0x3E,0x08,0x08,0x00}, // '+'
  {0x00,0x50,0x30,0x00,0x00,0x00}, // ','
  {0x08,0x08,0x08,0x08,0x08,0x00}, // '-'
  {0x00,0x60,0x60,0x00,0x00,0x00}, // '.'
  {0x20,0x10,0x08,0x04,0x02,0x00}, // '/'
  {0x3E,0x51,0x49,0x45,0x3E,0x00}, // '0'
  {0x00,0x42,0x7F,0x40,0x00,0x00}, // '1'
  {0x42,0x61,0x51,0x49,0x46,0x00}, // '2'
  {0x21,0x41,0x45,0x4B,0x31,0x00}, // '3'
  {0x18,0x14,0x12,0x7F,0x10,0x00}, // '4'
  {0x27,0x45,0x45,0x45,0x39,0x00}, // '5'
  {0x3C,0x4A,0x49,0x49,0x30,0x00}, // '6'
  {0x01,0x71,0x09,0x05,0x03,0x00}, // '7'
  {0x36,0x49,0x49,0x49,0x36,0x00}, // '8'
  {0x06,0x49,0x49,0x29,0x1E,0x00}, // '9'
  {0x00,0x36,0x36,0x00,0x00,0x00}, // ':'
  {0x7E,0x11,0x11,0x11,0x7E,0x00}, // 'A' 65
  {0x7F,0x49,0x49,0x49,0x36,0x00}, // 'B'
  {0x3E,0x41,0x41,0x41,0x22,0x00}, // 'C'
  {0x7F,0x41,0x41,0x22,0x1C,0x00}, // 'D'
  {0x7F,0x49,0x49,0x49,0x41,0x00}, // 'E'
  {0x7F,0x09,0x09,0x09,0x01,0x00}, // 'F'
  {0x3E,0x41,0x49,0x49,0x7A,0x00}, // 'G'
  {0x7F,0x08,0x08,0x08,0x7F,0x00}, // 'H'
  {0x00,0x41,0x7F,0x41,0x00,0x00}, // 'I'
  {0x20,0x40,0x41,0x3F,0x01,0x00}, // 'J'
  {0x7F,0x08,0x14,0x22,0x41,0x00}, // 'K'
  {0x7F,0x40,0x40,0x40,0x40,0x00}, // 'L'
  {0x7F,0x02,0x0C,0x02,0x7F,0x00}, // 'M'
  {0x7F,0x04,0x08,0x10,0x7F,0x00}, // 'N'
  {0x3E,0x41,0x41,0x41,0x3E,0x00}, // 'O'
  {0x7F,0x09,0x09,0x09,0x06,0x00}, // 'P'
  {0x3E,0x41,0x51,0x21,0x5E,0x00}, // 'Q'
  {0x7F,0x09,0x19,0x29,0x46,0x00}, // 'R'
  {0x46,0x49,0x49,0x49,0x31,0x00}, // 'S'
  {0x01,0x01,0x7F,0x01,0x01,0x00}, // 'T'
  {0x3F,0x40,0x40,0x40,0x3F,0x00}, // 'U'
  {0x1F,0x20,0x40,0x20,0x1F,0x00}, // 'V'
  {0x7F,0x20,0x18,0x20,0x7F,0x00}, // 'W'
  {0x63,0x14,0x08,0x14,0x63,0x00}, // 'X'
  {0x07,0x08,0x70,0x08,0x07,0x00}, // 'Y'
  {0x61,0x51,0x49,0x45,0x43,0x00}, // 'Z'
};

void drawChar(uint16_t x, uint16_t y, char c, uint16_t fg, uint16_t bg, uint8_t scale) {
  if (c < 32 || c > 90) c = '?';
  const uint8_t* glyph = kFont6x8[c - 32];
  for (uint8_t col = 0; col < 6; ++col) {
    uint8_t bits = glyph[col];
    for (uint8_t row = 0; row < 8; ++row) {
      uint16_t color = (bits & 0x01) ? fg : bg;
      if (scale == 1) {
        setAddrWindow(x + col, y + row, x + col, y + row);
        pushColor(color, 1);
      } else {
        fillRect(x + col * scale, y + row * scale, scale, scale, color);
      }
      bits >>= 1;
    }
  }
}

void drawText(uint16_t x, uint16_t y, const char* s, uint16_t fg, uint16_t bg, uint8_t scale) {
  uint16_t cx = x;
  for (; *s; ++s) {
    if (*s == '\n') { y += 8 * scale + 2; cx = x; continue; }
    drawChar(cx, y, *s, fg, bg, scale);
    cx += 6 * scale + 1;
  }
}

}  // namespace

void init() {
  pinMode(kCs, OUTPUT);
  pinMode(kDc, OUTPUT);
  pinMode(kRst, OUTPUT);
  digitalWrite(kCs, HIGH);
  SPI.begin(sedu::pins::kSpiSck, sedu::pins::kSpiMiso, sedu::pins::kSpiMosi, kCs);

  digitalWrite(kRst, LOW);
  delay(20);
  digitalWrite(kRst, HIGH);
  delay(50);
  sendCmd(0x01);  // SWRESET
  delay(120);
  sendCmd(0x11);  // SLPOUT
  delay(120);
  uint8_t colmod = 0x55;  // 16-bit color
  cmdData(0x3A, &colmod, 1);
  sendCmd(0x29);  // DISPON
}

void splash(float batt_volts, float batt_percent, const __FlashStringHelper* ladder_text,
            bool drv_ok, float ipropi_amps) {
  // Clear to dark background
  const uint16_t bg = color565(0x10, 0x10, 0x10);
  const uint16_t fg = color565(0xE0, 0xE0, 0xE0);
  fillRect(0, 0, kW, kH, bg);

  char buf[64];
  snprintf(buf, sizeof(buf), "SEDU\nBATT %.2fV (%.1f%%)", batt_volts, batt_percent);
  drawText(8, 8, buf, fg, bg, 2);
  snprintf(buf, sizeof(buf), "LADDER %s\nDRV %s\nIPROPI %.2fA",
           reinterpret_cast<const char*>(ladder_text), drv_ok ? "OK" : "FAULT", ipropi_amps);
  drawText(8, 60, buf, fg, bg, 2);
}

}  // namespace sedu::lcd
